name: Release Build

# Trigger on release publication
on:
  release:
    types: [published]

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
      
      - name: Build binary for ${{ matrix.os }}/${{ matrix.arch }}
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          mkdir -p dist
          go build -o dist/frozendb-${{ matrix.os }}-${{ matrix.arch }} ./cmd/frozendb
          
          # Verify binary was created
          if [ ! -f "dist/frozendb-${{ matrix.os }}-${{ matrix.arch }}" ]; then
            echo "Error: Binary was not created"
            exit 1
          fi
          
          # Display file info
          ls -lh dist/frozendb-${{ matrix.os }}-${{ matrix.arch }}
      
      - name: Upload binary to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/frozendb-${{ matrix.os }}-${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
