# Data Model: Release Scripts & Version Management

**Feature**: 033-release-scripts  
**Date**: 2026-01-29  
**Purpose**: Define data entities, validation rules, and state changes for version management

## Overview

This feature introduces version management entities and release workflow state. Since this is an infrastructure feature (scripts and CI/CD), there are no traditional database entities. Instead, this document defines the data structures and validation rules for version information and release artifacts.

## Version Information Entity

### Version String

**Description**: Semantic version identifier for frozenDB releases

**Format**: `vMAJOR.MINOR.PATCH[-PRERELEASE]`

**Attributes**:
- **Prefix**: Must be lowercase 'v'
- **Major**: Integer ≥ 0 (breaking changes)
- **Minor**: Integer ≥ 0 (backward-compatible features)
- **Patch**: Integer ≥ 0 (backward-compatible fixes)
- **Prerelease** (optional): Alphanumeric with dots and hyphens (e.g., "rc1", "beta.2", "alpha")

**Examples**:
- Valid: v0.1.0, v1.2.3, v2.0.0-rc1, v1.0.0-beta.2
- Invalid: 0.1.0 (no 'v'), v1.2 (missing patch), V1.0.0 (uppercase), v1.2.3.4 (too many parts)

**Storage Locations**:
1. **go.mod**: Module version field
2. **cmd/frozendb/version.go**: Go constant `Version`
3. **Git branch**: Encoded in branch name `release/{version}`
4. **Git tag**: Created when release is published (e.g., `v0.1.0`)

### Validation Rules

**VR-001**: Version string MUST match regex `^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$`

**VR-002**: Version components (major, minor, patch) MUST be non-negative integers

**VR-003**: Prerelease tag (if present) MUST NOT be empty and MUST contain only alphanumeric characters, dots, and hyphens

**VR-004**: Version string MUST NOT exceed 50 characters total length

**VR-005**: New version MUST be different from current version (no no-op bumps)

## Release Branch Entity

### Branch Information

**Description**: Git branch created specifically for preparing a release

**Naming Pattern**: `release/{version}`

**Attributes**:
- **Base branch**: Always created from `main`
- **Branch name**: Derived from version (e.g., `release/v0.1.0`)
- **Commit count**: Exactly one commit (the version bump)
- **Commit message**: `"Bump version to {version}"`
- **Remote tracking**: Must be pushed to origin

**State Flow**:
```
1. [main branch] → Check for uncommitted changes
2. [main branch] → Create release branch
3. [release branch] → Update go.mod
4. [release branch] → Generate version.go
5. [release branch] → Commit changes
6. [release branch] → Push to remote
7. [User action] → Create PR
8. [User action] → Merge PR to main
9. [User action] → Create GitHub release
10. [GitHub Actions] → Build and attach binaries
```

### Validation Rules

**BR-001**: Release branch MUST be created from `main` branch

**BR-002**: Release branch name MUST follow pattern `release/v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?`

**BR-003**: Branch MUST NOT already exist locally or remotely

**BR-004**: Exactly one commit MUST be present on the branch (beyond base)

**BR-005**: Commit MUST include exactly two changed files: go.mod and cmd/frozendb/version.go

## Build Artifact Entity

### Binary Artifact

**Description**: Compiled frozendb CLI binary for a specific platform and architecture

**Naming Pattern**: `frozendb-{os}-{arch}`

**Supported Platforms**:
| OS | Architecture | Artifact Name |
|----|-------------|---------------|
| darwin | amd64 | frozendb-darwin-amd64 |
| darwin | arm64 | frozendb-darwin-arm64 |
| linux | amd64 | frozendb-linux-amd64 |
| linux | arm64 | frozendb-linux-arm64 |

**Attributes**:
- **Executable**: Binary file (no extension)
- **Embedded version**: Contains version string from version.go
- **Platform**: Operating system (darwin, linux)
- **Architecture**: CPU architecture (amd64, arm64)
- **Build environment**: Go 1.25.5 in GitHub Actions

**Validation Rules**:

**BA-001**: Binary MUST be executable on target platform

**BA-002**: Binary MUST report correct version when `frozendb version` is executed

**BA-003**: Binary filename MUST match pattern `frozendb-(darwin|linux)-(amd64|arm64)`

**BA-004**: Binary MUST be attached to corresponding GitHub release

## Version File Entity

### version.go File

**Description**: Generated Go source file containing version constant

**Location**: `cmd/frozendb/version.go`

**Format**:
```go
// version.go - Generated by scripts/bump-version.sh
// DO NOT EDIT: This file is automatically generated
package main

const Version = "v0.1.0"
```

**Attributes**:
- **Package**: Must be `main` (same as cmd/frozendb/main.go)
- **Constant name**: `Version` (exported, string type)
- **Value**: Current version string in quoted format
- **Comments**: Warning that file is auto-generated

**Validation Rules**:

**VF-001**: File MUST be valid Go source code that compiles

**VF-002**: Version constant MUST match version in go.mod

**VF-003**: Package declaration MUST be `package main`

**VF-004**: Constant MUST be exported (capitalized `Version`)

## Error Conditions

### Version Bump Script Errors

**ER-001: Invalid Version Format**
- Condition: Provided version doesn't match semantic versioning pattern
- Handling: Exit with code 1, display format requirements

**ER-002: Branch Already Exists**
- Condition: Release branch with same name exists locally or remotely
- Handling: Exit with code 1, suggest checking existing branches

**ER-003: Uncommitted Changes**
- Condition: Working directory has uncommitted changes
- Handling: Warn user, wait for confirmation or Ctrl+C

**ER-004: Git Operation Failed**
- Condition: Any git command (checkout, commit, push) fails
- Handling: Exit with code 1, display git error message, note that local changes remain

**ER-005: File Generation Failed**
- Condition: Cannot write version.go or update go.mod
- Handling: Exit with code 1, display file operation error

**ER-006: Remote Push Failed**
- Condition: Push to remote repository fails
- Handling: Exit with code 1, note that local branch and commit exist, user can retry push manually

### CLI Version Command Errors

**ER-007: Version Constant Missing**
- Condition: version.go doesn't exist or Version constant undefined
- Handling: Display "frozendb (development)" instead of version

**ER-008: Binary Not Executable**
- Condition: User doesn't have execute permissions
- Handling: OS-level error, user must fix permissions

### Build Workflow Errors

**ER-009: Compilation Failed**
- Condition: Go build fails for any platform
- Handling: GitHub Actions workflow fails, display compilation errors

**ER-010: Artifact Upload Failed**
- Condition: Cannot attach binary to GitHub release
- Handling: GitHub Actions workflow fails, display upload errors

**ER-011: Missing version.go**
- Condition: Release created without version.go in repository
- Handling: Compilation fails (undefined constant), workflow fails

## Data Flow Diagram

```
[Maintainer] --> [bump-version script]
                      |
                      ├─> Validate version format (VR-001 to VR-005)
                      ├─> Check working directory (ER-003)
                      ├─> Create branch (BR-001 to BR-003)
                      ├─> Update go.mod (VF-002)
                      ├─> Generate version.go (VF-001, VF-003, VF-004)
                      ├─> Commit changes (BR-004, BR-005)
                      └─> Push to remote (ER-006)

[Release Branch] --> [GitHub PR] --> [main branch]
                                          |
                                          └─> [Maintainer creates GitHub release]
                                                      |
                                                      └─> [GitHub Actions Workflow]
                                                               |
                                                               ├─> Build darwin/amd64 (BA-001 to BA-004)
                                                               ├─> Build darwin/arm64 (BA-001 to BA-004)
                                                               ├─> Build linux/amd64 (BA-001 to BA-004)
                                                               ├─> Build linux/arm64 (BA-001 to BA-004)
                                                               └─> Attach all artifacts to release

[User] --> [Download binary] --> [Execute: frozendb version]
                                       |
                                       └─> Display: "frozendb v0.1.0" (BA-002)
```

## State Transitions

### Version Bump Workflow State Machine

```
State: INITIAL
├─> Action: Run bump-version.sh with version argument
├─> Validation: Check version format
│   ├─> INVALID → State: ERROR (ER-001)
│   └─> VALID → State: VERSION_VALIDATED
│
State: VERSION_VALIDATED
├─> Action: Check for uncommitted changes
│   ├─> HAS_CHANGES → State: AWAITING_USER_CONFIRM (ER-003)
│   │   ├─> User confirms → State: CREATING_BRANCH
│   │   └─> User cancels (Ctrl+C) → State: ABORTED
│   └─> CLEAN → State: CREATING_BRANCH
│
State: CREATING_BRANCH
├─> Action: git checkout -b release/{version}
│   ├─> FAIL → State: ERROR (ER-002, ER-004)
│   └─> SUCCESS → State: BRANCH_CREATED
│
State: BRANCH_CREATED
├─> Action: Update go.mod and generate version.go
│   ├─> FAIL → State: ERROR (ER-005)
│   └─> SUCCESS → State: FILES_UPDATED
│
State: FILES_UPDATED
├─> Action: git commit
│   ├─> FAIL → State: ERROR (ER-004)
│   └─> SUCCESS → State: COMMITTED
│
State: COMMITTED
├─> Action: git push origin release/{version}
│   ├─> FAIL → State: ERROR (ER-006)
│   └─> SUCCESS → State: COMPLETE
│
State: COMPLETE
└─> Script exits with code 0
```

### Release Build Workflow State Machine

```
State: IDLE
├─> Event: GitHub release published
└─> State: TRIGGERED

State: TRIGGERED
├─> Action: Checkout repository at release tag
├─> Action: Setup Go 1.25.5
└─> State: ENVIRONMENT_READY

State: ENVIRONMENT_READY
├─> Action: Build darwin/amd64
│   ├─> FAIL → State: BUILD_FAILED (ER-009)
│   └─> SUCCESS → Continue
├─> Action: Build darwin/arm64
│   ├─> FAIL → State: BUILD_FAILED (ER-009)
│   └─> SUCCESS → Continue
├─> Action: Build linux/amd64
│   ├─> FAIL → State: BUILD_FAILED (ER-009)
│   └─> SUCCESS → Continue
├─> Action: Build linux/arm64
│   ├─> FAIL → State: BUILD_FAILED (ER-009)
│   └─> SUCCESS → State: ALL_BUILDS_COMPLETE

State: ALL_BUILDS_COMPLETE
├─> Action: Attach binaries to release
│   ├─> FAIL → State: UPLOAD_FAILED (ER-010)
│   └─> SUCCESS → State: COMPLETE

State: COMPLETE
└─> Workflow succeeds, release has all binary artifacts
```

## Integration Points

### With Existing CLI Structure

The version command integrates into the existing cmd/frozendb/main.go command router:

**Existing commands**: create, begin, commit, savepoint, rollback, add, get  
**New command**: version

**Integration**: Version command is checked before existing command router, supporting both `frozendb version` subcommand and `frozendb --version` flag patterns.

### With Git Workflow

**Existing branches**: main, feature branches (e.g., 010-null-row-struct)  
**New branches**: release/* branches for version bumps  
**Integration**: Release branches are short-lived (create → PR → merge → delete), separate from feature development branches.

### With CI/CD

**Existing workflow**: `.github/workflows/ci.yml` - Runs on push and PR to main  
**New workflow**: `.github/workflows/release.yml` - Runs on release publication  
**Integration**: Independent workflows, no conflicts. CI validates all code, release workflow only builds binaries.
